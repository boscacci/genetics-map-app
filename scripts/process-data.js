const fs = require('fs');
const path = require('path');
const dotenv = require('dotenv');
const Papa = require('papaparse');
const CryptoJS = require('crypto-js');

// Load .env
const envPath = path.resolve(__dirname, '../.env');
dotenv.config({ path: envPath });
const SECRET_KEY = process.env.REACT_APP_SECRET_KEY;
if (!SECRET_KEY) {
  throw new Error('REACT_APP_SECRET_KEY not found in .env');
}

// Read and parse CSV
const csvPath = path.resolve(__dirname, '../data.csv');
let csvContent;
if (fs.existsSync(csvPath)) {
  csvContent = fs.readFileSync(csvPath, 'utf8');
} else if (process.env.DATA_CSV) {
  csvContent = process.env.DATA_CSV;
  console.log('Loaded CSV data from DATA_CSV environment variable.');
} else {
  throw new Error('No data.csv file found and DATA_CSV environment variable is not set.');
}
const { data, errors } = Papa.parse(csvContent, {
  header: true,
  dynamicTyping: true,
  skipEmptyLines: true,
});
if (errors.length > 0) {
  console.error('CSV parsing errors:', errors);
}

// Filter and clean data (similar to parseCSVString)
const cleanLanguageString = (languageString) => {
  if (!languageString) return '';
  return languageString
    .replace(/[.,;!?()\[\]{}"'`]/g, '')
    .replace(/\s+/g, ' ')
    .trim();
};
const parsedData = (data).filter((item) => {
  return item.Latitude && item.Longitude &&
    !Number.isNaN(Number(item.Latitude)) && !Number.isNaN(Number(item.Longitude));
}).map((item) => ({
  ...item,
  language_spoken: cleanLanguageString(item.language_spoken),
  interpreter_services: typeof item.uses_interpreters === 'string' ? item.uses_interpreters : 'unknown',
}));

// Encrypt JSON string
const jsonString = JSON.stringify(parsedData);
const encrypted = CryptoJS.AES.encrypt(jsonString, SECRET_KEY).toString();

// Write to src/secureDataBlob.ts
const outputPath = path.resolve(__dirname, '../src/secureDataBlob.ts');
const output = `// This file is auto-generated by scripts/process-data.js\nexport const ENCRYPTED_SPECIALISTS_DATA = "${encrypted}";\n`;
fs.writeFileSync(outputPath, output, 'utf8');
console.log('Encrypted data written to src/secureDataBlob.ts'); 